<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Meal Planner with Login</title>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCiE49f5ZWS0jiwmnVYJkdkTgVzAfTGNKY",
            authDomain: "cw-test-d6fd8.firebaseapp.com",
            projectId: "cw-test-d6fd8",
            storageBucket: "cw-test-d6fd8.appspot.com",
            messagingSenderId: "1015783240778",
            appId: "1:1015783240778:web:d6da49fc9c5d7d3f1f22b3",
            measurementId: "G-QB9MK37JGQ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Show planner section
        function showPlannerSection(user) {
            document.getElementById('planner-section').style.display = 'block';
            document.getElementById('quiz-section').style.display = 'none';
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('userEmail').textContent = user ? user.email : "Test User";

            if (user) {
                fetchUserData(user.uid);
            }
        }

        function hidePlannerSection() {
            document.getElementById('planner-section').style.display = 'none';
            document.getElementById('quiz-section').style.display = 'none';
            document.getElementById('auth-section').style.display = 'block';
        }

        // Fetch user data from Firestore
        async function fetchUserData(userId) {
            const userDoc = await getDoc(doc(db, 'users', userId));
            if (userDoc.exists()) {
                const data = userDoc.data();
                // Handle user data
            }
        }

        // Save user data to Firestore
        async function saveUserData(userId, quizData) {
            await setDoc(doc(db, 'users', userId), { ...quizData, quizCompleted: true });
        }

        // User registration
        async function registerUser() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                console.log('User registered:', user);
                showQuizSection(user);
            } catch (error) {
                console.error('Registration error:', error);
                alert('Registration failed. Please try again.');
            }
        }

        // User login
        async function loginUser() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                console.log('User logged in:', user);
                showQuizSection(user);
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please check your credentials.');
            }
        }

        // User logout
        async function logoutUser() {
            try {
                await signOut(auth);
                console.log('User logged out');
                hidePlannerSection();
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout failed. Please try again.');
            }
        }

        // Show quiz section
        function showQuizSection(user) {
            document.getElementById('quiz-section').style.display = 'block';
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('planner-section').style.display = 'none';
            document.getElementById('userEmail').textContent = user.email;
        }

        // Submit quiz and save preferences
        async function submitQuiz() {
            const goal = document.querySelector('input[name="goal"]:checked')?.value;
            const allergies = document.querySelector('input[name="allergies"]:checked')?.value;
            const allergyDetails = allergies === 'yes' ? document.getElementById('allergyDetails').value : '';
            const budget = document.querySelector('input[name="budget"]:checked')?.value;
            const cookingTime = document.querySelector('input[name="cookingTime"]:checked')?.value;

            const quizData = {
                goal,
                allergies: {
                    hasAllergies: allergies,
                    details: allergyDetails
                },
                budget,
                cookingTime
            };

            if (goal && budget && cookingTime) {
                if (auth.currentUser) {
                    await saveUserData(auth.currentUser.uid, quizData);
                    showPlannerSection(auth.currentUser);
                }
            } else {
                alert('Please answer all questions before submitting.');
            }
        }

        // Toggle allergy details visibility
        function toggleAllergyDetails(show) {
            document.getElementById('allergyDetailsContainer').style.display = show ? 'block' : 'none';
        }

        // Check authentication state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Check if the user has completed the quiz
                fetchUserData(user.uid).then((data) => {
                    if (data && data.quizCompleted) {
                        showPlannerSection(user);
                    } else {
                        showQuizSection(user);
                    }
                });
            } else {
                hidePlannerSection();
            }
        });

        // Attach event listeners to buttons
        window.addEventListener('load', () => {
            document.getElementById('registerButton').addEventListener('click', registerUser);
            document.getElementById('loginButton').addEventListener('click', loginUser);
            document.getElementById('logoutButton').addEventListener('click', logoutUser);
            document.getElementById('submitQuizButton').addEventListener('click', submitQuiz);
        });
    </script>

    <!-- Styles -->
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        input, button, select {
            margin: 5px 0;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
        }
        button:hover {
            background-color: #45a049;
        }
        ul {
            list-style-type: none;
            padding: 0;
        }
        li {
            background-color: #f9f9f9;
            margin: 5px 0;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .meal-plan {
            background-color: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Meal Planner with User Login</h1>

        <!-- User Authentication Section -->
        <div id="auth-section">
            <h2>Login or Register</h2>
            <input type="email" id="emailInput" placeholder="Enter your email">
            <input type="password" id="passwordInput" placeholder="Enter your password">
            <button id="registerButton">Register</button>
            <button id="loginButton">Login</button>
        </div>

        <!-- Quiz Section -->
        <div id="quiz-section" style="display:none;">
            <h2>Introductory Quiz</h2>
            <form id="quizForm">
                <h3>Question 1: What is your goal?</h3>
                <input type="radio" name="goal" value="weight_loss"> Weight Loss<br>
                <input type="radio" name="goal" value="bulk"> Bulk<br>

                <h3>Question 2: Any allergies?</h3>
                <input type="radio" name="allergies" value="yes" onclick="toggleAllergyDetails(true)"> Yes<br>
                <input type="radio" name="allergies" value="no" onclick="toggleAllergyDetails(false)"> No<br>
                <div id="allergyDetailsContainer" style="display:none;">
                    <input type="text" id="allergyDetails" placeholder="Please specify your allergies">
                </div>

                <h3>Question 3: What is your budget?</h3>
                <input type="radio" name="budget" value="low"> Low<br>
                <input type="radio" name="budget" value="medium"> Medium<br>
                <input type="radio" name="budget" value="high"> High<br>

                <h3>Question 4: What is your preferred cooking time?</h3>
                <input type="radio" name="cookingTime" value="quick"> Quick (under 30 minutes)<br>
                <input type="radio" name="cookingTime" value="medium"> Medium (30-60 minutes)<br>
                <input type="radio" name="cookingTime" value="slow"> Slow (over 60 minutes)<br>

                <button type="button" id="submitQuizButton">Submit Quiz</button>
                <button type="button" id="logoutButton" style="background-color: #f44336;">Logout</button>
            </form>
        </div>

        <!-- Planner Section -->
        <div id="planner-section" style="display:none;">
            <h2>Your Meal Planner</h2>
            <p>Welcome, <span id="userEmail"></span>!</p>
            <div class="meal-plan">
                <!-- Meal plan will be displayed here -->
                <ul>
                    <li>Meal 1: Breakfast</li>
                    <li>Meal 2: Lunch</li>
                    <li>Meal 3: Dinner</li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>
